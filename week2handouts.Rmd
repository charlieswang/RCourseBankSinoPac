---
title: "R ETL Crash Course"
subtitle: Week 2
author:
    name: "Summit Suen"
    affiliation: 木刻思股份有限公司
    email: "course@agilearning.io, summit.suen@data-sci.info"
    website: "https://data-sci.info"
date: "January 04, 2016"
output: 
  html_document:
    toc: true
    theme: readable
    highlight: espresso
    css: main.css
---

# 今天的題目是 ETL：什麼是 ETL？

## E = Extract

## T = Transform

## L = Load

---

# 今天會用到的套件／重要函式：

## - `readLine` | `read.table`

## - `XLConnect` | `xlsx`

## - `readxl`

## - `magrittr` | `dplyr`

## - `RSQLite`

```{r}
library(readxl)
library(magrittr)
library(dplyr)
library(RSQLite)
```

<!-- end of list -->

## 環境設定：rJava Installation

在 Windows 系統裡使用 R，有時候會遇到一些棘手的 error；其中除了跟系統編碼（顯示亂碼）相關的問題以外，有一大宗都跟 `rJava` 這個套件有關。

今天先帶領大家操作一次，當遇到問題時，可以如何去解決。

- 下載 64 bits 版本的 Java（for Windows）[Download](http://javadl.sun.com/webapps/download/AutoDL?BundleId=113219)

<<<<<截圖>>>>>

<<<<<截圖>>>>>

<!-- end of list -->

---

# 暖身

## 練習操作：複習 R 語法

小提示 Tips

- 工作目錄 working directory
    - `getwd`
    - `setwd`
    - `dir`
   
- 自動補齊 autocompletion
    - `tab`

- 執行命令 source
    - `control` + `enter`

- 註解增減 comment
    - `shift` + `control` + `c`

<!-- end of list -->

<<<<<操作>>>>>

```{r}
## View Data
head(iris)
tail(iris)

## View(iris)
summary(iris)

attributes(iris)
str(iris)
class(iris)

## data shape
dim(iris)
ncol(iris)
nrow(iris)
```

---

# 什麼是資料第二問：資料「應該」長怎樣？

<<<<<PCHOME截圖>>>>>

Data Schema Matters！

資料結構是重要的

以第一週 Yahoo Stock 資料為例

<<<<<YAHOO截圖>>>>>

[2451 創見](http://tw.stock.yahoo.com/d/s/major_2451.html)

```{r}
library(httr)
library(rvest)

## Connector
Target_URL = "http://tw.stock.yahoo.com/d/s/major_2451.html"
res <- GET(Target_URL)
doc_str <- content(res, type = "text", encoding = "big5")

## Parser
if (.Platform$OS.type == "windows"){
  Sys.setlocale(category='LC_ALL', locale='C')
  data_table <- doc_str %>% read_html(encoding = "big-5") %>% html_nodes(xpath = "//table[1]//table[2]") %>% html_table(header=TRUE)
  Sys.setlocale(category='LC_ALL', locale='cht')
  data_table <- apply(data_table[[1]],2,function(x) iconv(x,from = "utf8"))
  colnames(data_table) <- iconv(colnames(data_table), from = "utf8")
}  else{
  data_table <- doc_str %>% read_html(encoding = "big-5") %>% html_nodes(xpath = "//table[1]//table[2]") %>% html_table(header=TRUE)
  data_table <- data_table[[1]]
}
# View(data_table)
data_table
```

左右兩欄的表格應該整併成同一欄

並且加入時間欄位

塞進資料庫／檔案做儲存

```{r}
head(data_table)
colnames(data_table) <- c("券商", "買進", "賣出", "差距", "券商", "買進", "賣出", "差距")
stockMajor <- rbind(data_table[,1:4], data_table[,5:8])
# stockMajor <- cbind(日期 = c(Sys.Date()), 股票代號 = c("2451"), 股票名稱 = c("創見"), stockMajor)
stockMajor <- cbind(日期 = c("2015-12-31"), 股票代號 = c("2451"), 股票名稱 = c("創見"), stockMajor)
# View(stockMajor)
head(stockMajor)
```

- 範例：Yahoo Stock

- 練習：Yahoo Stock

- 作業：無

<!-- end of list -->

---

# 基本資料讀寫

我今天拿到一個文字檔案

首先，觀察檔案的格式、欄位、資料型態

## 利用 `readLines`，先把前幾筆資料讀進來觀察

```{r}
res <- readLines(con = "data/cl_info_other.csv", n = 10L, encoding = "BIG-5")
head(res)
```

<<<<<分隔>>>>>

## 其他都可以忘記，至少要記得 `read.table`

## 利用 `colClasses` 指定資料中欄位的大小及資料型態，讓讀檔速度加快（執行時不用去猜資料的大小、格式與資料型態）

```{r}
# library(RCurl)
# Cl_info = read.table(sep=",", header=TRUE, stringsAsFactors=F, file=textConnection(getURL("https://raw.githubusercontent.com/suensummit/RCourseBankSinoPac/gh-pages/data/cl_info_other.csv")))

Cl_info = read.table(file = "data/cl_info_other.csv", sep = ",", stringsAsFactors = F, header = T, colClasses = c("character", "integer", "Date", "character", "Date", "character", "integer", "numeric", "integer", "numeric", "integer", "numeric", "integer", "numeric", "integer", "numeric"))
head(Cl_info)
str(Cl_info)
```

## 使用 `write.table` 寫資料

```{r, eval=FALSE}
write.table(x = Cl_info, file = "data/cl_info_other.csv", sep = ",", quote = FALSE)
```

[銀行局](https://survey.banking.gov.tw/statis/stmain.jsp?sys=100&funid=r100)

- 範例：房貸餘額 [csv](https://raw.githubusercontent.com/suensummit/RCourseBankSinoPac/gh-pages/data/cl_info_other.csv)

- 練習：

- 作業：無

<!-- end of list -->

---

# 處理 Excel 資料

## Excel 不等於 Table！

## - `gdata`

[在 Windows 系統中需要另外安裝 Perl](https://cran.r-project.org/web/packages/gdata/INSTALL)

```{r}
## Need Perl on Windows
library(gdata)
```

## - `XLConnect` and `xlsx`

需要 `rJava`，另外在處理中文編碼時需要使用 `iconv` 輔助。

```{r}
## Need Java/rJava
library(XLConnect)
library(xlsx)
```

## - `readxl`

Made by Hadley 品質保證，powerd by `RCpp`

```{r}
##
library(readxl)
```

<!-- end of list -->

---

# 觀察

首先，觀察檔案的格式、欄位、資料型態

套件::函式（public）
套件:::函式（private）

## 利用 `readxl:::xlsx_col_types` 觀察資料中欄位的大小及資料型態，讓讀檔速度加快（執行時不用去猜資料的大小、格式與資料型態）

## 使用 `readxl::excel_sheets` 取得 Excel 檔案的表單資訊（sheet），再用 `readxl::read_excel` 讀檔

```{r}
# library(readxl)
filename <- "data/10401信用卡重要資訊揭露.xlsx"
sheetNames <- readxl::excel_sheets(filename)
sheetNames
colTypes <- readxl:::xlsx_col_types(path = filename, nskip = 10, n = 1)
colTypes
```

<<<<<截圖>>>>>

```{r}
resxl <- readxl::read_excel(filename, sheet = sheetNames[1], col_names = FALSE, skip = 8, col_types = colTypes)
colnames(resxl) <- c("金融機構名稱", "流通卡數", "有效卡數", "當月發卡數", "當月停卡數", "循環信用餘額", "未到期分期付款餘額", "當月簽帳金額", "當月預借現金金額", "逾期三個月以上帳款占應收帳款餘額含催收款之比率", "逾期六個月以上帳款占應收帳款餘額含催收款之比率", "備抵呆帳提足率", "當月轉銷呆帳金額", "當年度轉銷呆帳金額累計至資料月份")
dataLength <- sum(1 - is.na(resxl$流通卡數))
resxl <- resxl[1:dataLength,]
# colnames(resxl) <- iconv(colnames(resxl), 'utf8', 'big5')
str(resxl)
# View(resxl)
```

## 大量同樣格式的檔案，包成 `function` 批次執行。

```{r}
setwd("./data/")
filenames <- dir(pattern = "*.xlsx")
readCreditExcel <- function(filename) {
  sheetNames <- readxl::excel_sheets(filename)
  colTypes <- readxl:::xlsx_col_types(path = filename, nskip = 10, n = 1)
  resxl <- readxl::read_excel(filename, sheet = sheetNames[1], col_names = FALSE, skip = 8, col_types = colTypes)
  colnames(resxl) <- c("金融機構名稱", "流通卡數", "有效卡數", "當月發卡數", "當月停卡數", "循環信用餘額", "未到期分期付款餘額", "當月簽帳金額", "當月預借現金金額", "逾期三個月以上帳款占應收帳款餘額含催收款之比率", "逾期六個月以上帳款占應收帳款餘額含催收款之比率", "備抵呆帳提足率", "當月轉銷呆帳金額", "當年度轉銷呆帳金額累計至資料月份")
  dataLength <- sum(1 - is.na(resxl$流通卡數))
  resxl <- resxl[1:dataLength,]
  resxl <- cbind(月份 = substr(filename, 1, 5), resxl)
  return(resxl)
}
filenames
creditData <- lapply(filenames, readCreditExcel)
creditData <- do.call("rbind", creditData)
# View(creditData)
setwd("../")
```

<<<<<截圖解釋lapply>>>>>

---

# dplyr

接下來，真正開始用 R 來做 ETL 資料清理的工作。

## 簡介 `dplyr`

官方的學習文件：`vignette`

```{r, eval=FALSE}
# library(dplyr)
vignette(all = TRUE, package = "dplyr")
vignette("introduction", package = "dplyr")
```

### - 讓 R 使用者可以用更有彈性的方式來處理資料

### - 針對 data.frame 做設計（名稱中的 d）

### - 設計理念
    + 導入資料整理最重要的操作（非常類似 SQL）
    + 快速與方便
    + 支援異質資料源（data.frame 或資料庫中的表格）

<!-- end of list -->

## dplyr 快速簡介

### - `select` 對欄位做篩選

### - `filter` 對資料列做篩選

### - `mutate` 變更或新增欄位

### - `arrange` 排序、排列

### - `group_by` + `summarise` 分類

### - `bind` 合併資料表

<!-- end of list -->

---

## `select`

### `Cl_demo1 = select(資料表, 欄位1, 欄位2, 欄位3)`

### 對應的 SQL 語法：
`select data_dt, bank_nm, mortgage_bal from Cl_info ;`

```{r}
# Example 1: select
Cl_demo1 = select(Cl_info, data_dt, bank_nm, mortgage_bal)
head(Cl_demo1)
```

## `filter`

### `Cl_demo2 = filter(Cl_info, mortgage_bal > 1000000)`

### 對應的 SQL 語法：
`select * from Cl_info where mortgage > 1000000 ;`

```{r}
# Example 2: filter
Cl_demo2 = filter(Cl_info, mortgage_bal > 1000000)
head(Cl_demo2)
```

## `mutate`

### `Cl_demo3 = mutate(資料表, 新欄位名 = 運算式)`

### 對應的 SQL 語法：
`select mortgage_bal/1000000 as mortage from Cl_info ;`

```{r}
# Example 3: mutate
Cl_demo3 = mutate(Cl_info, mortage = mortgage_bal/1000000)
head(Cl_demo3)
```

## `arrange`

### `Cl_demo4 = arrange(資料表, 欄位1, desc(欄位2)))`

### 對應的 SQL 語法：
`select * from Cl_info order by mortage, data_dt desc ;`

```{r}
# Example 4: arrange
Cl_demo4 = arrange(Cl_info, mortgage_bal, desc(data_dt))
head(Cl_demo4)
```

## `group_by` + `summarise`

### `Cl_demo5 = summarise(group_by(資料表, 用以分組的欄位), 彙總欄位)`

### 對應的 SQL 語法：
`select mean(mortgage_cnt) from Cl_info group by bank_nm ;`

```{r}
# Example 5: group_by + summarise
Cl_demo5 = summarise(group_by(Cl_info, bank_nm), mean(mortgage_cnt))
head(Cl_demo5)
```

---

## 實際拿剛才的 EXCEL 資料來處理

```{r, eval=FALSE}
# Example:
try <- select(creditData, 金融機構名稱, 月份, 流通卡數, 有效卡數, 當月發卡數, 當月停卡數, 逾期三個月以上帳款占應收帳款餘額含催收款之比率)

# 圖還要修！
library(ggplot2)
ggplot(try, aes(x = 月份, y = 流通卡數)) + geom_line()

```

---

## R 與 Database 的串接：以 SQLite 為例

```{r}
library(DBI)
# Create an ephemeral in-memory RSQLite database
con <- dbConnect(RSQLite::SQLite(), ":memory:")

dbListTables(con)
dbWriteTable(con, "mtcars", mtcars)
dbListTables(con)

dbListFields(con, "mtcars")
dbReadTable(con, "mtcars")

# You can fetch all results:
res <- dbSendQuery(con, "SELECT * FROM mtcars WHERE cyl = 4")
dbFetch(res)
dbClearResult(res)

# Or a chunk at a time
res <- dbSendQuery(con, "SELECT * FROM mtcars WHERE cyl = 4")
while(!dbHasCompleted(res)){
  chunk <- dbFetch(res, n = 5)
  print(nrow(chunk))
}
# Clear the result
dbClearResult(res)

# Disconnect from the database
dbDisconnect(con)
```

請大家操作範例資料

[範例資料簡介](http://mlr.cs.umass.edu/ml/datasets/Bank+Marketing)

[下載範例資料](http://mlr.cs.umass.edu/ml/machine-learning-databases/00222/bank.zip)

```{r}
res <- read.csv("data/bank/bank-full.csv", header = TRUE, sep = ";")
```

---

## Take Home Messages

### - 資料結構是重要的，三思而後行！

### - 觀察
###    + (1) `head` + `tail` + `summary`
###    + (2) `readLines` + `read.table`
###    + (3) `readxl:::xlsx_col_types`

### - Excel
###    + (1) `gdata`
###    + (2) `XLConnect` + `xlsx`
###    + (3) `readxl`**

### - `dplyr`

### - Database: 
###    + (1) Connect
###    + (2) Query
###    + (3) Disconnect

---

## Q & A

[四周課程列表](./index.html)
